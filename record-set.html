<!DOCTYPE html>
<link href='../polymer/polymer.html' rel='import'>
<polymer-element name='record-set'>
  <template></template>
  <script>
    (function() {
      var data, fields, getFields,
        __hasProp = {}.hasOwnProperty;
    
      data = {};
    
      fields = {};
    
      getFields = function(record) {
        var k, p, v, _ref, _results;
        if (fields[record.tagName] != null) {
          return fields[record.tagName];
        }
        p = HTMLElement.getPrototypeForTag(record.tagName);
        while (true) {
          if (p.element["extends"] == null) {
            throw "not a record: " + record.tagName;
          }
          if (p.element["extends"] === "record-base") {
            break;
          }
          p = HTMLElement.getPrototypeForTag(p.element["extends"]);
        }
        _ref = p.publish;
        _results = [];
        for (k in _ref) {
          if (!__hasProp.call(_ref, k)) continue;
          v = _ref[k];
          _results.push(k);
        }
        return _results;
      };
    
      Polymer({
        _data: void 0,
        computed: {
          all: '_extractRecords(_data)'
        },
        ready: function() {
          return this._data = data;
        },
        save: function(record) {
          var k, r, _i, _len, _ref, _results;
          if (this._data[record.type] == null) {
            this._data[record.type] = {
              records: {},
              next: 1
            };
          }
          r = this._data[record.type].records[record.rid];
          if (r == null) {
            r = {};
          }
          if (r.rid == null) {
            r.rid = this._data[record.type].next++;
          }
          this._data[record.type].records[r.rid] = r;
          _ref = getFields(record);
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            k = _ref[_i];
            _results.push(r[k] = record[k]);
          }
          return _results;
        },
        load: function(record) {
          var k, v, _ref, _results;
          if ((this._data[record.type] != null) && (this._data[record.type].records[record.rid] != null)) {
            _ref = this._data[record.type].records[record.rid];
            _results = [];
            for (k in _ref) {
              v = _ref[k];
              if (k !== "rid") {
                _results.push(record[k] = v);
              } else {
                _results.push(void 0);
              }
            }
            return _results;
          }
        },
        _extractRecords: function(data) {
          return new function() {
            var id, record, type, value;
            for (type in data) {
              value = data[type];
              this[type] = (function() {
                var _ref, _results;
                _ref = value.records;
                _results = [];
                for (id in _ref) {
                  record = _ref[id];
                  _results.push(record.rid);
                }
                return _results;
              })();
            }
            return this;
          };
        }
      });
    
    }).call(this);
  </script>
</polymer-element>
<polymer-element attributes='rid persist type' name='record-base'>
  <template>
    <record-set id='set'></record-set>
  </template>
  <script>
    (function() {
      Polymer({
        rid: void 0,
        observe: {
          '$.set._data': 'load'
        },
        computed: {
          all: '$.set.all[type]'
        },
        ready: function() {
          if (this.persist != null) {
            this.save();
          }
          if (this.rid != null) {
            return this.load();
          }
        },
        save: function() {
          return this.$.set.save(this);
        },
        load: function() {
          return this.$.set.load(this);
        },
        _lc: function(s) {
          return s.toLowerCase();
        }
      });
    
    }).call(this);
  </script>
</polymer-element>
