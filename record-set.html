<!DOCTYPE html>
<link href='../polymer/polymer.html' rel='import'>
<link href='../core-ajax/core-ajax.html' rel='import'>
<polymer-element attributes='href' name='record-set'>
  <template></template>
  <script>
    (function() {
      var getFields, __data, __dummy, __fields, __href,
        __hasProp = {}.hasOwnProperty;
    
      __data = {};
    
      __dummy = {
        data: 0
      };
    
      __href = void 0;
    
      __fields = {};
    
      getFields = function(record) {
        var k, p, v;
        if (__fields[record.tagName] != null) {
          return __fields[record.tagName];
        }
        p = HTMLElement.getPrototypeForTag(record.tagName);
        while (true) {
          if (p.element["extends"] == null) {
            throw "not a record: " + record.tagName;
          }
          if (p.element["extends"] === "record-base") {
            break;
          }
          p = HTMLElement.getPrototypeForTag(p.element["extends"]);
        }
        return __fields[record.tagName] = (function() {
          var _ref, _results;
          _ref = p.publish;
          _results = [];
          for (k in _ref) {
            if (!__hasProp.call(_ref, k)) continue;
            v = _ref[k];
            _results.push(k);
          }
          return _results;
        })();
      };
    
      Polymer({
        href: void 0,
        _data: void 0,
        _dummy: void 0,
        computed: {
          all: '_extractRecords(_data, _dummy.data)'
        },
        created: function() {
          this._data = __data;
          return this._dummy = __dummy;
        },
        ready: function() {
          if (this.href != null) {
            __href = this.href;
          }
          if (this.href !== __href) {
            return this.href = __href;
          }
        },
        save: function(record, remote) {
          var data, k, r, _i, _len, _ref;
          data = record;
          if (remote != null) {
            remote.rid = remote.id;
            delete remote.id;
            data = remote;
          }
          if (this._data[record.type] == null) {
            this._data[record.type] = {
              records: {},
              next: 1
            };
          }
          r = this._data[record.type].records[data.rid];
          if (r == null) {
            r = {};
          }
          if (r.rid == null) {
            r.rid = remote != null ? remote.rid : "rs:" + this._data[record.type].next++;
          }
          this._data[record.type].records[r.rid] = r;
          _ref = getFields(record);
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            k = _ref[_i];
            r[k] = data[k];
          }
          return this._dummy.data++;
        },
        load: function(record) {
          var k, v, _ref, _results;
          if ((this._data[record.type] != null) && (this._data[record.type].records[record.rid] != null)) {
            _ref = this._data[record.type].records[record.rid];
            _results = [];
            for (k in _ref) {
              v = _ref[k];
              if (k !== "rid") {
                _results.push(record[k] = v);
              } else {
                _results.push(void 0);
              }
            }
            return _results;
          }
        },
        "delete": function(record) {
          if ((this._data[record.type] != null) && (this._data[record.type].records[record.rid] != null)) {
            delete this._data[record.type].records[record.rid];
            return this._dummy.data++;
          }
        },
        _extractRecords: function(data) {
          return new function() {
            var id, record, type, value;
            for (type in data) {
              value = data[type];
              this[type] = (function() {
                var _ref, _results;
                _ref = value.records;
                _results = [];
                for (id in _ref) {
                  record = _ref[id];
                  _results.push(record.rid);
                }
                return _results;
              })();
            }
            return this;
          };
        }
      });
    
    }).call(this);
  </script>
</polymer-element>
<polymer-element attributes='rid persist type noautoload' name='record-base'>
  <template>
    <record-set id='set'></record-set>
    <core-ajax handleAs='json' id='ajax' on-core-response='{{_handleResponse}}'></core-ajax>
  </template>
  <script>
    (function() {
      Polymer({
        rid: void 0,
        persist: void 0,
        type: "record",
        noautoload: void 0,
        observe: {
          '$.set.all': '_doAutoLoad'
        },
        computed: {
          all: '$.set.all[type]'
        },
        ready: function() {
          if (this.persist != null) {
            this.save();
          }
          if ((this.rid != null) && (this.noautoload == null)) {
            return this.load();
          }
        },
        save: function() {
          return this.$.set.save(this);
        },
        load: function() {
          return this.$.set.load(this);
        },
        "delete": function() {
          return this.$.set["delete"](this);
        },
        pull: function() {
          var x;
          x = this.$.ajax;
          x.url = this.$.set.href + "/" + this.type;
          x.method = "GET";
          x.body = null;
          return x.go();
        },
        _handleResponse: function(e, d) {
          var k, record, _i, _len, _ref, _ref1, _results, _results1;
          if (Array.isArray(d.response)) {
            _ref = d.response;
            _results = [];
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              record = _ref[_i];
              _results.push(this.$.set.save(this, record));
            }
            return _results;
          } else {
            _ref1 = d.response;
            _results1 = [];
            for (k in _ref1) {
              record = _ref1[k];
              if (record.id == null) {
                record.id = k;
              }
              _results1.push(this.$.set.save(this, record));
            }
            return _results1;
          }
        },
        _doAutoLoad: function() {
          if (this.noautoload == null) {
            return this.load();
          }
        },
        _lc: function(s) {
          return s.toLowerCase();
        },
        noautoloadChanged: function() {
          return this._doAutoLoad();
        }
      });
    
    }).call(this);
  </script>
</polymer-element>
